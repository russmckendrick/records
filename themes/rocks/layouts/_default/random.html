{{ define "main" }}

<!-- random.html -->

<section id="banner" class="style3">
    <div class="inner">
        <header class="major">
            <h1 id="album-title"></h1>
        </header>
        <div class="content">
            <p><button class="button primary large" id="get-random-album">Grab Another Random Album</button></p>
        </div>
    </div>
</section>

<!-- Main -->
<div id="main">

    <section id="two" class="spotlights">
        <section>
            <a href="#" id="image-link-album" class="image">
                <img id="album-image" alt="Album cover" data-position="center center">
            </a>
            <div class="content">
                <div class="inner">
                    <header class="major">
                        <h3><span id="album-album"></span> by <span id="album-artist"></span></h3>
                    </header>
                    <p>Date added: <span id="album-date"></span></p>
                    <ul class="actions">
                        <li><a href="#" id="goto-album" class="button">Goto Album</a></li>
                    </ul>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    const albumsUrl = "/index.json";
    const albumTitleEl = document.getElementById('album-title');
    const albumArtistEl = document.getElementById('album-artist');
    const albumAlbumEl = document.getElementById('album-album');
    const albumImageEl = document.getElementById('album-image');
    const albumDateEl = document.getElementById('album-date');
    const getRandomAlbumBtn = document.getElementById('get-random-album');
    const gotoAlbumLink = document.getElementById('goto-album');
    let albums;

    fetch(albumsUrl)
        .then(response => response.text())
        .then(data => {
            data = data.replace(/&nbsp;/g, ' '); // replace non-breaking space characters with regular spaces
            albums = JSON.parse(data).documents;
            getRandomAlbum();
        })
        .catch(error => console.error(error)); // log any errors to the console

    function getRandomAlbum() {
        let randomIndex = Math.floor(Math.random() * albums.length);
        let randomAlbum = albums[randomIndex];

        for(let i = 0; i < 6; i++) { // cycle through 6 random albums
            setTimeout(() => {
                randomIndex = Math.floor(Math.random() * albums.length);
                randomAlbum = albums[randomIndex];
                updateAlbum(randomAlbum);
            }, i * 500); // delay each change by half a second
        }

        setTimeout(() => { // after 3 seconds, settle on the final album
            randomIndex = Math.floor(Math.random() * albums.length);
            randomAlbum = albums[randomIndex];
            updateAlbum(randomAlbum);
            gotoAlbumLink.href = randomAlbum.uri;
        }, 3000);
    }

    function updateAlbum(album) {
        albumTitleEl.textContent = album.title;
        albumArtistEl.textContent = album.artist;
        albumAlbumEl.textContent = album.album;
        albumImageEl.src = album.coverImage;
        albumImageEl.alt = album.album + ' cover';
        albumDateEl.textContent = album.date;
    }

    getRandomAlbumBtn.addEventListener('click', getRandomAlbum);
    gotoAlbumLink.addEventListener('click', (event) => {
        event.preventDefault();
        window.location.href = gotoAlbumLink.href;
    });
</script>

{{ end }}
