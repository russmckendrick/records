{{ define "window_title" }}{{ .Title | upper }} :: DATABASE_TAXONOMY{{ end }}

{{ define "main" }}
<!-- Breadcrumb -->
<div class="breadcrumb">
    <a href="{{ "/" | relURL }}">Home</a> / {{ .Title }}
</div>

<!-- Search and Filter Controls -->
<div class="filter-controls">
    <div class="search-container">
        <label for="termSearch">SEARCH {{ .Title | upper }}:</label>
        <input type="text" id="termSearch" placeholder="Type to filter {{ .Title | lower }}..." oninput="filterTerms()">
    </div>
    
    <div class="view-controls">
        <div class="view-stats">
            <span id="termCount">{{ len (index .Site.Taxonomies (lower .Title)) }}</span> {{ .Title | upper }} FOUND
        </div>
        <div class="sort-controls">
            <label>SORT BY:</label>
            <select id="sortSelect" onchange="sortTerms()">
                <option value="name">NAME</option>
                <option value="count">ALBUM COUNT</option>
            </select>
        </div>
    </div>
</div>

<!-- Alphabetical Navigation -->
<div class="alpha-nav">
    <span class="alpha-label">JUMP TO:</span>
    {{- $letters := split "#ABCDEFGHIJKLMNOPQRSTUVWXYZ" "" -}}
    {{ range $letters }}
    <a href="#{{ . }}" class="alpha-link" data-letter="{{ . }}">{{ . }}</a>{{ if not (eq . "Z") }} | {{ end }}
    {{ end }}
    <button class="alpha-link" onclick="showAll()" id="showAllBtn">ALL</button>
</div>

<!-- Single Table View -->
<div class="terms-table-container">
    <div class="db-section">
        <div class="db-header">
            <div class="sortable" onclick="sortBy('id')">
                ID 
                <span class="sort-indicator" id="sort-id"></span>
            </div>
            <div class="sortable" onclick="sortBy('name')">
                {{ .Title | upper }}_NAME 
                <span class="sort-indicator" id="sort-name">↑</span>
            </div>
            <div class="sortable" onclick="sortBy('count')">
                ALBUM_COUNT 
                <span class="sort-indicator" id="sort-count"></span>
            </div>
            <div>STATUS</div>
        </div>
        
        <div id="termsContainer">
            {{- $taxonomy := index .Site.Taxonomies (lower .Title) -}}
            {{ range $index, $term := $taxonomy.Alphabetical }}
            <div class="db-row term-row" 
                 data-name="{{ $term.Page.Title | lower }}" 
                 data-count="{{ $term.Count }}"
                 data-letter="{{ upper (substr $term.Page.Title 0 1) }}"
                 onclick="window.location.href='{{ $term.Page.RelPermalink | relURL }}'">
                <div class="record-id">#{{ printf "%04d" (add $index 1) }}</div>
                <div class="term-name">{{ $term.Page.Title }}</div>
                <div class="term-count">{{ $term.Count }}</div>
                <div><div class="status-indicator"></div></div>
            </div>
            {{ end }}
        </div>
    </div>
</div>

<style>
/* Filter Controls */
.filter-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 2rem 0;
    padding: 1rem;
    border: 1px solid var(--border-color);
    background: var(--window-bg);
    gap: 2rem;
    flex-wrap: wrap;
}

[data-era="90s"] .filter-controls {
    border: 1px inset #c0c0c0;
    background: #e0e0e0;
}

.search-container {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.search-container label {
    color: var(--text-color);
    font-family: var(--font-family);
    font-weight: 600;
    font-size: 0.8rem;
}

.search-container input {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 0.5rem;
    font-family: var(--font-family);
    font-size: 0.9rem;
    min-width: 250px;
    flex: 1;
}

[data-era="90s"] .search-container input {
    border: 1px inset #c0c0c0;
    background: white;
    color: black;
}

.view-controls {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.view-stats {
    color: var(--accent-color);
    font-family: var(--font-family);
    font-weight: 600;
    font-size: 0.9rem;
}

.sort-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sort-controls label {
    color: var(--text-color);
    font-family: var(--font-family);
    font-weight: 600;
    font-size: 0.8rem;
}

.sort-controls select {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 0.25rem 0.5rem;
    font-family: var(--font-family);
    font-size: 0.8rem;
}

[data-era="90s"] .sort-controls select {
    border: 1px inset #c0c0c0;
    background: white;
    color: black;
}

/* Alpha Navigation */
.alpha-nav {
    margin: 1rem 0;
    padding: 1rem;
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    text-align: center;
    font-family: var(--font-family);
    background: var(--highlight-bg);
}

.alpha-label {
    color: var(--text-color);
    font-weight: 600;
    margin-right: 1rem;
}

.alpha-link {
    color: var(--text-color);
    text-decoration: none;
    font-weight: 600;
    padding: 0.25rem;
    transition: color 0.3s ease;
    background: none;
    border: none;
    font-family: var(--font-family);
    cursor: pointer;
}

.alpha-link:hover {
    color: var(--accent-color);
    text-decoration: none;
}

.alpha-link.active {
    color: var(--accent-color);
    background: rgba(255, 255, 0, 0.2);
    padding: 0.25rem 0.5rem;
}

/* Table Styles */
.terms-table-container {
    margin: 2rem 0;
}

.db-section {
    margin: 1rem 0;
}

.db-header {
    display: grid;
    grid-template-columns: 80px 3fr 1fr 100px;
    gap: 1rem;
    padding: 1rem 0;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 1rem;
    font-weight: 600;
    color: var(--text-color);
    text-transform: uppercase;
    font-size: 0.8rem;
}

.sortable {
    cursor: pointer;
    user-select: none;
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sortable:hover {
    color: var(--accent-color);
}

.sort-indicator {
    font-size: 0.7rem;
    opacity: 0.7;
}

.db-row {
    display: grid;
    grid-template-columns: 80px 3fr 1fr 100px;
    gap: 1rem;
    padding: 1rem 0;
    border-bottom: 1px solid var(--border-color);
    transition: all 0.3s ease;
    cursor: pointer;
    align-items: center;
}

.db-row:hover {
    background: var(--highlight-bg);
}

[data-era="90s"] .db-row:hover {
    background: var(--highlight-bg);
    color: white;
}

.db-row.hidden {
    display: none;
}

.term-name {
    color: var(--text-color);
    font-weight: 500;
}

.term-count {
    color: var(--secondary-text);
    font-weight: 600;
}

.record-id {
    font-family: var(--font-family);
    color: var(--secondary-text);
    font-size: 0.8rem;
}

.status-indicator {
    width: 8px;
    height: 8px;
    background: var(--accent-color);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

[data-era="90s"] .status-indicator {
    border-radius: 0;
    background: #008000;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
}

@media (max-width: 768px) {
    .filter-controls {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .search-container {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
    }
    
    .search-container input {
        min-width: auto;
    }
    
    .view-controls {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
        text-align: center;
    }
    
    .db-header {
        display: none;
    }
    
    .db-row {
        display: block;
        padding: 1rem;
        border: 1px solid var(--border-color);
        margin-bottom: 0.5rem;
        border-radius: 3px;
    }
    
    .alpha-nav {
        font-size: 0.8rem;
        padding: 0.5rem;
    }
}
</style>

<script>
let currentSort = 'name';
let sortDirection = 'asc';
let allTerms = [];

document.addEventListener('DOMContentLoaded', function() {
    // Store all terms for filtering
    allTerms = Array.from(document.querySelectorAll('.term-row'));
    updateTermCount();
});

function filterTerms() {
    const searchTerm = document.getElementById('termSearch').value.toLowerCase();
    const terms = document.querySelectorAll('.term-row');
    let visibleCount = 0;
    
    terms.forEach(term => {
        const name = term.dataset.name;
        if (name.includes(searchTerm)) {
            term.classList.remove('hidden');
            visibleCount++;
        } else {
            term.classList.add('hidden');
        }
    });
    
    document.getElementById('termCount').textContent = visibleCount;
    
    // Clear alpha navigation active states when searching
    if (searchTerm) {
        document.querySelectorAll('.alpha-link').forEach(link => {
            link.classList.remove('active');
        });
    }
}

function sortTerms() {
    const sortBy = document.getElementById('sortSelect').value;
    sortBy(sortBy);
}

function sortBy(column) {
    // Toggle direction if same column
    if (currentSort === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortDirection = 'asc';
    }
    
    currentSort = column;
    
    // Update sort indicators
    document.querySelectorAll('.sort-indicator').forEach(indicator => {
        indicator.textContent = '';
    });
    
    const indicator = document.getElementById(`sort-${column}`);
    if (indicator) {
        indicator.textContent = sortDirection === 'asc' ? '↑' : '↓';
    }
    
    // Sort terms
    const container = document.getElementById('termsContainer');
    const terms = Array.from(container.querySelectorAll('.term-row'));
    
    terms.sort((a, b) => {
        let aVal, bVal;
        
        switch(column) {
            case 'name':
                aVal = a.dataset.name;
                bVal = b.dataset.name;
                break;
            case 'count':
                aVal = parseInt(a.dataset.count);
                bVal = parseInt(b.dataset.count);
                break;
            case 'id':
                aVal = parseInt(a.querySelector('.record-id').textContent.replace('#', ''));
                bVal = parseInt(b.querySelector('.record-id').textContent.replace('#', ''));
                break;
        }
        
        if (column === 'count' || column === 'id') {
            return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
        } else {
            if (sortDirection === 'asc') {
                return aVal.localeCompare(bVal);
            } else {
                return bVal.localeCompare(aVal);
            }
        }
    });
    
    // Re-number and re-append
    terms.forEach((term, index) => {
        term.querySelector('.record-id').textContent = `#${String(index + 1).padStart(4, '0')}`;
        container.appendChild(term);
    });
    
    // Update select dropdown
    document.getElementById('sortSelect').value = column;
}

function showAll() {
    document.querySelectorAll('.term-row').forEach(term => {
        term.classList.remove('hidden');
    });
    
    document.getElementById('termSearch').value = '';
    updateTermCount();
    
    // Clear alpha navigation active states
    document.querySelectorAll('.alpha-link').forEach(link => {
        link.classList.remove('active');
    });
    document.getElementById('showAllBtn').classList.add('active');
}

function updateTermCount() {
    const visibleTerms = document.querySelectorAll('.term-row:not(.hidden)');
    document.getElementById('termCount').textContent = visibleTerms.length;
}

// Alpha navigation
document.querySelectorAll('.alpha-link[data-letter]').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const letter = this.dataset.letter;
        
        // Clear search
        document.getElementById('termSearch').value = '';
        
        // Filter by letter
        const terms = document.querySelectorAll('.term-row');
        let visibleCount = 0;
        
        terms.forEach(term => {
            if (letter === '#') {
                // Show non-alphabetic
                if (!/^[A-Z]/.test(term.dataset.letter)) {
                    term.classList.remove('hidden');
                    visibleCount++;
                } else {
                    term.classList.add('hidden');
                }
            } else {
                if (term.dataset.letter === letter) {
                    term.classList.remove('hidden');
                    visibleCount++;
                } else {
                    term.classList.add('hidden');
                }
            }
        });
        
        document.getElementById('termCount').textContent = visibleCount;
        
        // Update active state
        document.querySelectorAll('.alpha-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
    });
});
</script>
{{ end }}